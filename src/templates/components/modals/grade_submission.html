<div class="modal fade" id="gradeSubmissionModal" tabindex="-1" aria-labelledby="gradeSubmissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gradeSubmissionModalLabel">
                    <i class="bi bi-clipboard-check me-2"></i><span id="gradeModalTitleText">Grade Submission</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'grade_submission' %}">
                {% csrf_token %}
                <input type="hidden" name="submission_id" id="gradeSubmissionId">
                <input type="hidden" name="is_edit" id="gradeIsEdit" value="0">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-secondary-color">Activity</label>
                        <div class="form-control bg-light" disabled>{{ activity.title }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="gradeScore" class="form-label">Score</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gradeScore" name="score" min="0" max="{{ activity.total_marks }}" step="1" required data-max-score="{{ activity.total_marks }}">
                            <span class="input-group-text">/ {{ activity.total_marks }}</span>
                        </div>
                        <div class="form-text">Enter a value between 0 and {{ activity.total_marks }}.</div>
                        <div class="invalid-feedback" id="scoreError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="gradeFeedback" class="form-label">Feedback (optional)</label>
                        <textarea class="form-control" id="gradeFeedback" name="feedback" rows="3" placeholder="Provide brief feedback for the student"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="gradeSubmitButton">
                        <i class="bi bi-send me-1"></i><span id="gradeSubmitText">Submit Grade</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openGradingModal(submissionId, currentScore = null, currentFeedback = '') {
    const idField = document.getElementById('gradeSubmissionId');
    const scoreField = document.getElementById('gradeScore');
    const feedbackField = document.getElementById('gradeFeedback');
    const isEditField = document.getElementById('gradeIsEdit');
    const titleText = document.getElementById('gradeModalTitleText');
    const submitText = document.getElementById('gradeSubmitText');
    const submitButton = document.getElementById('gradeSubmitButton');
    const scoreError = document.getElementById('scoreError');
    
    idField.value = submissionId;
    if (currentScore !== null && currentScore !== undefined) {
        scoreField.value = currentScore;
        isEditField.value = '1';
        titleText.textContent = 'Edit Grade';
        submitText.textContent = 'Update Grade';
    } else {
        scoreField.value = '';
        isEditField.value = '0';
        titleText.textContent = 'Grade Submission';
        submitText.textContent = 'Submit Grade';
    }
    feedbackField.value = currentFeedback || '';

    // Reset validation state
    scoreField.classList.remove('is-invalid');
    scoreError.textContent = '';
    submitButton.disabled = false;

    const modalEl = document.getElementById('gradeSubmissionModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

// Add real-time validation
document.addEventListener('DOMContentLoaded', function() {
    const scoreField = document.getElementById('gradeScore');
    const submitButton = document.getElementById('gradeSubmitButton');
    const scoreError = document.getElementById('scoreError');

    if (scoreField) {
        const maxScore = parseInt(scoreField.dataset.maxScore || 0);
        
        scoreField.addEventListener('input', function() {
            const score = parseInt(this.value);
            let isValid = true;
            let errorMessage = '';

            if (isNaN(score)) {
                isValid = false;
                errorMessage = 'Please enter a valid number.';
            } else if (score < 0) {
                isValid = false;
                errorMessage = 'Score cannot be negative.';
            } else if (score > maxScore) {
                isValid = false;
                errorMessage = `Score cannot exceed ${maxScore} points.`;
            }

            if (isValid) {
                this.classList.remove('is-invalid');
                scoreError.textContent = '';
                submitButton.disabled = false;
            } else {
                this.classList.add('is-invalid');
                scoreError.textContent = errorMessage;
                submitButton.disabled = true;
            }
        });

        // Prevent form submission if validation fails
        const form = scoreField.closest('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const score = parseInt(scoreField.value);
                if (isNaN(score) || score < 0 || score > maxScore) {
                    e.preventDefault();
                    scoreField.classList.add('is-invalid');
                    if (score > maxScore) {
                        scoreError.textContent = `Score cannot exceed ${maxScore} points.`;
                    }
                }
            });
        }
    }
});
</script>



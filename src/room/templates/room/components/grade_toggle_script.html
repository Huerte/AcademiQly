<script>
document.addEventListener('DOMContentLoaded', function() {
    const gradeToggle = document.getElementById('gradeToggleInput');
    const percentLabel = document.getElementById('percentLabel');
    const scaleLabel = document.getElementById('scaleLabel');
    const gradeBadges = document.querySelectorAll('.grade-badge');
    const overallGradeValue = document.getElementById('overall-grade-value');
    
    if (!gradeToggle) return;


    const basePassing = {{ room.base_passing|default:60 }};


    function percentToScale(percent) {
        if (percent >= basePassing + 36) return 1.0;
        else if (percent >= basePassing + 30) return 1.25;
        else if (percent >= basePassing + 24) return 1.5;
        else if (percent >= basePassing + 18) return 1.75;
        else if (percent >= basePassing + 12) return 2.0;
        else if (percent >= basePassing + 6) return 2.25;
        else if (percent >= basePassing) return 3.0;
        else return 5.0;
    }


    const studentGrades = {};
    gradeBadges.forEach(badge => {
        const studentId = badge.id.replace('grade-', '');
        const grade = parseFloat(badge.getAttribute('data-grade')) || 0;
        studentGrades[studentId] = grade;
    });

    function updateToggleLabels() {
        const isScaleMode = gradeToggle.checked;
        
        if (percentLabel && scaleLabel) {
            if (isScaleMode) {
                percentLabel.classList.remove('active');
                percentLabel.classList.add('inactive');
                scaleLabel.classList.remove('inactive');
                scaleLabel.classList.add('active');
            } else {
                percentLabel.classList.remove('inactive');
                percentLabel.classList.add('active');
                scaleLabel.classList.remove('active');
                scaleLabel.classList.add('inactive');
            }
        }
    }

    function updateGradeDisplay() {
        const isScaleMode = gradeToggle.checked;
        
        gradeBadges.forEach(badge => {
            const studentId = badge.id.replace('grade-', '');
            const percentGrade = studentGrades[studentId] || 0;
            
            if (isScaleMode) {
                const scaleGrade = percentToScale(percentGrade);
                badge.textContent = scaleGrade.toFixed(2);
            } else {
                badge.textContent = Math.round(percentGrade) + '%';
            }
            
            badge.className = 'grade-badge';
            if (percentGrade >= 90) {
                badge.classList.add('grade-excellent');
            } else if (percentGrade >= 80) {
                badge.classList.add('grade-good');
            } else if (percentGrade >= 70) {
                badge.classList.add('grade-average');
            } else {
                badge.classList.add('grade-poor');
            }
        });

        if (overallGradeValue) {
            const basePercent = parseFloat(overallGradeValue.getAttribute('data-percent')) || 0;
            
            if (isScaleMode) {
                const scaleGrade = percentToScale(basePercent);
                overallGradeValue.textContent = scaleGrade.toFixed(2);
            } else {
                overallGradeValue.textContent = Math.round(basePercent) + '%';
            }
        }
    }

    updateToggleLabels();
    updateGradeDisplay();

    gradeToggle.addEventListener('change', function() {
        updateToggleLabels();
        updateGradeDisplay();
        
        localStorage.setItem('gradeDisplayMode', this.checked ? 'scale' : 'percent');
    });

    const savedMode = localStorage.getItem('gradeDisplayMode');
    if (savedMode === 'scale') {
        gradeToggle.checked = true;
        updateToggleLabels();
        updateGradeDisplay();
    }

    setInterval(function() {
        fetch(window.location.href, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const updatedBadges = doc.querySelectorAll('.grade-badge');
            
            updatedBadges.forEach(badge => {
                const studentId = badge.id.replace('grade-', '');
                const newGrade = parseFloat(badge.getAttribute('data-grade')) || 0;
                if (studentGrades[studentId] !== newGrade) {
                    studentGrades[studentId] = newGrade;
                    const currentBadge = document.getElementById(badge.id);
                    if (currentBadge) {
                        currentBadge.setAttribute('data-grade', newGrade);
                    }
                }
            });
            
            updateGradeDisplay();
        })
        .catch(error => {
            console.log('Grade update failed:', error);
        });
    }, 10000); 
});
</script>

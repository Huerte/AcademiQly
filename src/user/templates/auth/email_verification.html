{% extends 'base.html' %}

{% block title %}Verify Your Email{% endblock %}

{% block content %}
<div class="container-fluid min-vh-100 d-flex align-items-stretch bg-light">
	<div class="row g-0 w-100">
		<div class="col-lg-6 d-none d-lg-flex align-items-center justify-content-center p-5">
			<div class="text-center" role="img" aria-label="Email verification illustration">
				<img src="https://images.unsplash.com/photo-1596526131083-e8c633c948d2?q=80&w=1600&auto=format&fit=crop" alt="Email verification" class="img-fluid rounded-4 shadow" style="max-height: 520px; object-fit: cover;">
				<div class="mt-4">
					<h1 class="h3 fw-bold text-dark mb-2">Almost there!</h1>
					<p class="text-secondary-color mb-0">Check your email to complete your registration.</p>
				</div>
			</div>
		</div>

		<div class="col-lg-6 d-flex align-items-center justify-content-center p-4 p-lg-5">
			<div class="card shadow-lg border-0 w-100" style="max-width: 480px;">
				<div class="card-body p-4 p-lg-5">
					<div class="text-center mb-4">
						<div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success-subtle" style="width: 80px; height: 80px;">
							<i class="bi bi-envelope-check text-success fs-2" aria-hidden="true"></i>
						</div>
						<h2 class="h3 fw-bold text-dark mt-4 mb-2">Verify Your Email</h2>
						<p class="text-secondary-color">We've sent a verification code to</p>
						<p class="fw-medium text-dark mb-4" id="user-email">user@example.com</p>
					</div>

					<form id="verification-form">
						<div class="mb-4">
							<label for="verification-code" class="form-label fw-medium">Enter verification code</label>
							<div class="d-flex gap-2 justify-content-center">
								<input type="text" class="form-control form-control-lg text-center verification-input" id="code-1" maxlength="1" required>
								<input type="text" class="form-control form-control-lg text-center verification-input" id="code-2" maxlength="1" required>
								<input type="text" class="form-control form-control-lg text-center verification-input" id="code-3" maxlength="1" required>
								<input type="text" class="form-control form-control-lg text-center verification-input" id="code-4" maxlength="1" required>
								<input type="text" class="form-control form-control-lg text-center verification-input" id="code-5" maxlength="1" required>
								<input type="text" class="form-control form-control-lg text-center verification-input" id="code-6" maxlength="1" required>
							</div>
							<div class="form-text text-center mt-2">Enter the 6-digit code sent to your email</div>
						</div>

						<button type="submit" class="btn btn-primary btn-lg w-100 mb-3" id="verify-btn" disabled>
							Verify Email
						</button>
					</form>

					<div class="text-center">
						<p class="text-secondary-color mb-3">Didn't receive the code?</p>
						<div class="d-flex flex-column gap-2">
							<button type="button" class="btn btn-outline-secondary" id="resend-code-btn">
								<i class="bi bi-arrow-clockwise me-2"></i>Resend Code
							</button>
							<button type="button" class="btn btn-link text-primary-color" id="change-email-btn">
								Change Email Address
							</button>
						</div>
					</div>

					<div class="text-center mt-4">
						<small class="text-muted">By verifying your email, you agree to our <a href="#" class="text-decoration-none">Terms</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>.</small>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Change Email Modal -->
<div class="modal fade" id="changeEmailModal" tabindex="-1" aria-labelledby="changeEmailModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header border-0">
				<h5 class="modal-title fw-bold" id="changeEmailModalLabel">Change Email Address</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p class="text-secondary-color mb-4">Enter a new email address to receive the verification code.</p>
				<form id="change-email-form">
					<div class="mb-3">
						<label for="new-email" class="form-label fw-medium">New email address</label>
						<input type="email" class="form-control form-control-lg" id="new-email" placeholder="Enter new email" required>
					</div>
					<button type="submit" class="btn btn-primary btn-lg w-100">
						Send Code to New Email
					</button>
				</form>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block footer %}{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const verificationInputs = document.querySelectorAll('.verification-input');
    const verifyBtn = document.getElementById('verify-btn');
    const resendCodeBtn = document.getElementById('resend-code-btn');
    const changeEmailBtn = document.getElementById('change-email-btn');
    const changeEmailModal = new bootstrap.Modal(document.getElementById('changeEmailModal'));
    const userEmail = document.getElementById('user-email');
    
    let resendTimer = 0;
    let resendInterval;

    verificationInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value;
            
            if (!/^\d*$/.test(value)) {
                e.target.value = value.replace(/\D/g, '');
                return;
            }
            
            if (value && index < verificationInputs.length - 1) {
                verificationInputs[index + 1].focus();
            }
            
            checkFormCompletion();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                verificationInputs[index - 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
            
            pastedData.split('').forEach((digit, i) => {
                if (verificationInputs[i]) {
                    verificationInputs[i].value = digit;
                }
            });
            
            const nextEmptyIndex = pastedData.length < 6 ? pastedData.length : 5;
            verificationInputs[nextEmptyIndex].focus();
            
            checkFormCompletion();
        });
    });

    function checkFormCompletion() {
        const allFilled = Array.from(verificationInputs).every(input => input.value);
        verifyBtn.disabled = !allFilled;
    }

    document.getElementById('verification-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const code = Array.from(verificationInputs).map(input => input.value).join('');
        
        console.log('Verification code submitted:', code);
        
        verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Verifying...';
        verifyBtn.disabled = true;
        
        setTimeout(() => {
            alert('Email verified successfully! Redirecting to role selection...');
        }, 2000);
    });

    resendCodeBtn.addEventListener('click', function() {
        if (resendTimer > 0) return;
        
        console.log('Resending verification code');
        
        resendCodeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...';
        resendCodeBtn.disabled = true;
        
        setTimeout(() => {
            resendCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Resend Code';
            resendCodeBtn.disabled = false;
            
            startResendTimer();
        }, 1000);
    });

    function startResendTimer() {
        resendTimer = 60;
        resendCodeBtn.disabled = true;
        
        resendInterval = setInterval(() => {
            resendTimer--;
            resendCodeBtn.innerHTML = `Resend Code (${resendTimer}s)`;
            
            if (resendTimer <= 0) {
                clearInterval(resendInterval);
                resendCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Resend Code';
                resendCodeBtn.disabled = false;
            }
        }, 1000);
    }

    changeEmailBtn.addEventListener('click', function() {
        changeEmailModal.show();
    });

    document.getElementById('change-email-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const newEmail = document.getElementById('new-email').value;
        
        console.log('Changing email to:', newEmail);
        
        userEmail.textContent = newEmail;
        changeEmailModal.hide();
        
        verificationInputs.forEach(input => input.value = '');
        checkFormCompletion();
        
        alert('Verification code sent to new email address');
    });

    verificationInputs[0].focus();
});
</script>
{% endblock %}
